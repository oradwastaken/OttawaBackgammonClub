<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ottawa Area Backgammon Club - Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
<style>
  :root {
    color-scheme: dark;
    --bg-primary: light-dark(#f0f2f5, #0a0e1a);
    --bg-secondary: light-dark(#ffffff, #111827);
    --bg-card: light-dark(rgba(255, 255, 255, 0.85), rgba(17, 24, 39, 0.8));
    --bg-card-hover: light-dark(rgba(243, 244, 246, 0.95), rgba(31, 41, 55, 0.9));
    --border-card: light-dark(rgba(0, 0, 0, 0.12), rgba(255, 255, 255, 0.06));
    --text-primary: light-dark(#1e293b, #f1f5f9);
    --text-secondary: light-dark(#475569, #94a3b8);
    --text-muted: light-dark(#64748b, #64748b);
    --accent-gold: light-dark(#d97706, #f59e0b);
    --accent-gold-light: light-dark(#b45309, #fbbf24);
    --accent-blue: light-dark(#2563eb, #3b82f6);
    --accent-cyan: light-dark(#0891b2, #06b6d4);
    --accent-emerald: light-dark(#059669, #10b981);
    --accent-purple: light-dark(#7c3aed, #8b5cf6);
    --accent-rose: light-dark(#e11d48, #f43f5e);
    --accent-orange: light-dark(#ea580c, #f97316);
    --glow-gold: rgba(245, 158, 11, 0.15);
    --glow-blue: rgba(59, 130, 246, 0.15);
    --radius: 16px;
    --radius-sm: 10px;
    --shadow: light-dark(0 4px 30px rgba(0, 0, 0, 0.12), 0 4px 30px rgba(0, 0, 0, 0.4));
    --overlay-weak: light-dark(rgba(0, 0, 0, 0.03), rgba(255, 255, 255, 0.03));
    --overlay-subtle: light-dark(rgba(0, 0, 0, 0.04), rgba(255, 255, 255, 0.04));
    --overlay-faint: light-dark(rgba(0, 0, 0, 0.05), rgba(255, 255, 255, 0.05));
    --overlay-light: light-dark(rgba(0, 0, 0, 0.06), rgba(255, 255, 255, 0.06));
    --overlay-medium: light-dark(rgba(0, 0, 0, 0.08), rgba(255, 255, 255, 0.08));
    --overlay-hover: light-dark(rgba(0, 0, 0, 0.1), rgba(255, 255, 255, 0.1));
    --overlay-strong: light-dark(rgba(0, 0, 0, 0.12), rgba(255, 255, 255, 0.12));
    --chart-grid: light-dark(rgba(0, 0, 0, 0.06), rgba(255, 255, 255, 0.04));
    --chart-border: light-dark(rgba(0, 0, 0, 0.08), rgba(255, 255, 255, 0.06));
    --modal-backdrop: light-dark(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.7));
    --scrollbar-thumb: light-dark(rgba(0, 0, 0, 0.15), rgba(255, 255, 255, 0.1));
    --scrollbar-thumb-hover: light-dark(rgba(0, 0, 0, 0.25), rgba(255, 255, 255, 0.2));
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background:
      radial-gradient(ellipse 80% 50% at 50% -20%, rgba(245, 158, 11, 0.08), transparent),
      radial-gradient(ellipse 60% 40% at 80% 80%, rgba(59, 130, 246, 0.06), transparent),
      radial-gradient(ellipse 60% 40% at 20% 80%, rgba(139, 92, 246, 0.05), transparent);
    pointer-events: none;
    z-index: 0;
  }

  .container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 32px 24px;
    position: relative;
    z-index: 1;
  }

  /* Header */
  .header {
    text-align: center;
    margin-bottom: 48px;
    position: relative;
  }

  .header-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: rgba(245, 158, 11, 0.1);
    border: 1px solid rgba(245, 158, 11, 0.2);
    border-radius: 999px;
    padding: 6px 16px;
    font-size: 12px;
    font-weight: 600;
    color: var(--accent-gold);
    text-transform: uppercase;
    letter-spacing: 1.5px;
    margin-bottom: 16px;
  }

  .header h1 {
    font-size: clamp(2rem, 5vw, 3.2rem);
    font-weight: 900;
    letter-spacing: -1px;
    background: linear-gradient(135deg, var(--text-primary), #f59e0b);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    line-height: 1.1;
    margin-bottom: 8px;
  }

  .header p {
    color: var(--text-secondary);
    font-size: 15px;
    font-weight: 400;
  }

  /* Summary Stats Row */
  .summary-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 32px;
  }

  .summary-stat {
    background: var(--bg-card);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border-card);
    border-radius: var(--radius-sm);
    padding: 20px 24px;
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .summary-stat::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: var(--stat-accent, var(--accent-gold));
    opacity: 0.7;
  }

  .summary-stat:hover {
    transform: translateY(-2px);
    border-color: var(--overlay-strong);
  }

  .summary-stat .number {
    font-size: 2rem;
    font-weight: 800;
    color: var(--stat-accent, var(--accent-gold));
    line-height: 1;
    margin-bottom: 4px;
  }

  .summary-stat .label {
    font-size: 12px;
    font-weight: 500;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  /* Card */
  .card {
    background: var(--bg-card);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border-card);
    border-radius: var(--radius);
    padding: 28px;
    box-shadow: var(--shadow);
    transition: all 0.3s ease;
  }

  .card:hover {
    border-color: var(--overlay-hover);
  }

  .card-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1.5px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .card-title .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
  }

  /* Leaderboard */
  .leaderboard-section {
    margin-bottom: 32px;
  }

  .leaderboard-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
  }

  /* Podium */
  .podium-area {
    display: flex;
    flex-direction: column;
  }

  .podium {
    display: flex;
    align-items: flex-end;
    justify-content: center;
    gap: 12px;
    margin-bottom: 24px;
    padding-top: 20px;
  }

  .podium-slot {
    text-align: center;
    flex: 1;
    max-width: 160px;
  }

  .podium-avatar {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    font-size: 18px;
    margin: 0 auto 8px;
    border: 3px solid;
    position: relative;
  }

  .podium-slot:nth-child(1) .podium-avatar { /* 2nd place */
    background: rgba(148, 163, 184, 0.15);
    border-color: #94a3b8;
    color: light-dark(#475569, #cbd5e1);
  }
  .podium-slot:nth-child(2) .podium-avatar { /* 1st place */
    background: rgba(245, 158, 11, 0.2);
    border-color: var(--accent-gold);
    color: var(--accent-gold-light);
    width: 68px;
    height: 68px;
    font-size: 22px;
  }
  .podium-slot:nth-child(3) .podium-avatar { /* 3rd place */
    background: rgba(217, 119, 6, 0.15);
    border-color: #d97706;
    color: light-dark(#92400e, #fbbf24);
  }

  .podium-name {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .podium-pts {
    font-size: 18px;
    font-weight: 800;
    color: var(--accent-gold);
    margin-bottom: 2px;
  }

  .podium-sub {
    font-size: 11px;
    color: var(--text-muted);
  }

  .podium-bar {
    border-radius: 8px 8px 0 0;
    width: 100%;
    margin-top: 8px;
    transition: height 0.6s ease;
  }

  .podium-slot:nth-child(1) .podium-bar {
    height: 80px;
    background: linear-gradient(180deg, rgba(148, 163, 184, 0.3), rgba(148, 163, 184, 0.05));
  }
  .podium-slot:nth-child(2) .podium-bar {
    height: 110px;
    background: linear-gradient(180deg, rgba(245, 158, 11, 0.3), rgba(245, 158, 11, 0.05));
  }
  .podium-slot:nth-child(3) .podium-bar {
    height: 60px;
    background: linear-gradient(180deg, rgba(217, 119, 6, 0.25), rgba(217, 119, 6, 0.05));
  }

  .crown {
    position: absolute;
    top: -18px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 20px;
  }

  /* Table */
  .table-rest {
    flex: 1;
    margin-top: 8px;
  }

  .table-row {
    display: grid;
    grid-template-columns: 36px 1fr 80px 80px 70px;
    align-items: center;
    padding: 10px 12px;
    border-radius: 8px;
    transition: background 0.2s;
    gap: 8px;
  }

  .table-row:hover { background: var(--overlay-weak); }

  .table-row .rank {
    font-size: 13px;
    font-weight: 700;
    color: var(--text-muted);
    text-align: center;
  }

  .table-row .name {
    font-size: 13px;
    font-weight: 500;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .table-row .stat-val {
    font-size: 13px;
    font-weight: 600;
    text-align: right;
  }

  .table-header {
    font-size: 10px;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    border-bottom: 1px solid var(--border-card);
    padding-bottom: 8px;
    margin-bottom: 4px;
  }

  .table-header .stat-val { font-weight: 600; }

  /* Theme toggle */
  .theme-toggle {
    position: absolute;
    top: 0;
    right: 0;
    background: var(--overlay-faint);
    border: 1px solid var(--border-card);
    border-radius: 999px;
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 20px;
    color: var(--text-secondary);
    transition: all 0.3s ease;
  }

  .theme-toggle:hover {
    background: var(--overlay-medium);
    color: var(--text-primary);
    border-color: var(--overlay-strong);
  }

  /* Right side leaderboard chart */
  .leaderboard-chart-wrap {
    display: flex;
    flex-direction: column;
  }

  .leaderboard-chart-wrap canvas {
    flex: 1;
  }

  /* Grid layouts */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 32px;
  }

  .charts-grid-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin-bottom: 32px;
  }

  .charts-grid-3 {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 24px;
    margin-bottom: 32px;
  }

  .full-width {
    margin-bottom: 32px;
  }

  /* Mini leaderboard cards */
  .mini-board {
    list-style: none;
  }

  .mini-board li {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px solid var(--overlay-subtle);
    transition: all 0.2s;
  }

  .mini-board li:last-child { border-bottom: none; }

  .mini-board li:hover { padding-left: 4px; }

  .mini-board .mini-rank {
    width: 24px;
    height: 24px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 700;
    margin-right: 12px;
    flex-shrink: 0;
  }

  .mini-board .mini-name {
    font-size: 13px;
    font-weight: 500;
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .mini-board .mini-val {
    font-size: 14px;
    font-weight: 700;
    margin-left: 12px;
    white-space: nowrap;
    min-width: 40px;
    text-align: right;
  }

  .mini-board .mini-sub {
    font-size: 11px;
    color: var(--text-muted);
    margin-left: 8px;
    white-space: nowrap;
    min-width: 56px;
    text-align: right;
  }

  .stats-grid .card {
    min-width: 0;
    overflow: hidden;
  }

  .mini-left {
    display: flex;
    align-items: center;
    min-width: 0;
  }

  .mini-right {
    display: flex;
    align-items: center;
  }

  /* Bar visual */
  .bar-bg {
    height: 6px;
    background: var(--overlay-faint);
    border-radius: 3px;
    overflow: hidden;
    margin-top: 4px;
  }

  .bar-fill {
    height: 100%;
    border-radius: 3px;
    transition: width 1s ease;
  }

  /* Chart container */
  .chart-container {
    position: relative;
    width: 100%;
    min-height: 280px;
  }

  .chart-container canvas {
    width: 100% !important;
  }

  /* Year filter */
  .filter-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 24px;
    flex-wrap: wrap;
  }

  .filter-btn {
    background: var(--overlay-faint);
    border: 1px solid var(--overlay-medium);
    color: var(--text-secondary);
    padding: 6px 16px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'Inter', sans-serif;
  }

  .filter-btn:hover {
    background: var(--overlay-medium);
    color: var(--text-primary);
  }

  .filter-btn.active {
    background: rgba(245, 158, 11, 0.15);
    border-color: rgba(245, 158, 11, 0.3);
    color: var(--accent-gold);
  }

  .filter-label {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-right: 4px;
  }

  /* Footer */
  .footer {
    text-align: center;
    padding: 40px 0 20px;
    color: var(--text-muted);
    font-size: 12px;
  }

  /* Player detail modal */
  .modal-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: var(--modal-backdrop);
    backdrop-filter: blur(8px);
    z-index: 1000;
    justify-content: center;
    align-items: center;
    padding: 24px;
  }

  .modal-overlay.active { display: flex; }

  .modal {
    background: var(--bg-secondary);
    border: 1px solid var(--border-card);
    border-radius: var(--radius);
    max-width: 700px;
    width: 100%;
    max-height: 80vh;
    overflow-y: auto;
    padding: 32px;
    box-shadow: light-dark(0 25px 60px rgba(0, 0, 0, 0.15), 0 25px 60px rgba(0, 0, 0, 0.5));
    position: relative;
  }

  .modal-close {
    position: absolute;
    top: 16px;
    right: 16px;
    width: 32px;
    height: 32px;
    border-radius: 8px;
    border: 1px solid var(--overlay-hover);
    background: var(--overlay-faint);
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 18px;
    transition: all 0.2s;
  }

  .modal-close:hover {
    background: var(--overlay-hover);
    color: var(--text-primary);
  }

  .modal h2 {
    font-size: 1.5rem;
    font-weight: 800;
    margin-bottom: 4px;
    color: var(--accent-gold);
  }

  .modal-subtitle {
    color: var(--text-muted);
    font-size: 13px;
    margin-bottom: 24px;
  }

  .modal-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 24px;
  }

  .modal-stat {
    background: var(--overlay-weak);
    border-radius: 10px;
    padding: 16px;
    text-align: center;
  }

  .modal-stat .ms-val {
    font-size: 1.4rem;
    font-weight: 800;
    margin-bottom: 2px;
  }

  .modal-stat .ms-label {
    font-size: 11px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .modal-chart {
    width: 100%;
    height: 250px;
  }

  /* Tooltip overrides */
  .fade-in { animation: fadeIn 0.6s ease; }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .stagger-1 { animation-delay: 0.05s; }
  .stagger-2 { animation-delay: 0.1s; }
  .stagger-3 { animation-delay: 0.15s; }
  .stagger-4 { animation-delay: 0.2s; }
  .stagger-5 { animation-delay: 0.25s; }

  /* Responsive */
  @media (max-width: 1024px) {
    .stats-grid { grid-template-columns: repeat(2, 1fr); }
    .charts-grid-3 { grid-template-columns: 1fr; }
    .leaderboard-grid { grid-template-columns: 1fr; }
  }

  @media (max-width: 768px) {
    .summary-row { grid-template-columns: repeat(2, 1fr); }
    .charts-grid-2 { grid-template-columns: 1fr; }
    .container { padding: 16px; }
    .podium { gap: 8px; }
    .table-row { grid-template-columns: 30px 1fr 60px 60px; }
    .table-row .stat-val:last-child { display: none; }
  }

  @media (max-width: 480px) {
    .summary-row { grid-template-columns: 1fr 1fr; }
    .modal-stats { grid-template-columns: repeat(2, 1fr); }
  }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--scrollbar-thumb-hover); }

  /* Clickable rows */
  .clickable { cursor: pointer; }

  /* Header tools */
  .header-tools {
    position: absolute;
    top: 0;
    right: 0;
    display: flex;
    gap: 8px;
  }

  .header-tools .theme-toggle {
    position: static;
  }

  /* Data source indicator */
  .data-source-info {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 6px;
  }

  .data-source-info a {
    text-decoration: none;
    font-weight: 500;
  }

  .data-source-info a:hover {
    text-decoration: underline;
  }

  /* Upload modal */
  .upload-drop-zone {
    border: 2px dashed var(--border-card);
    border-radius: var(--radius-sm);
    padding: 40px 24px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    margin: 20px 0 16px;
    background: var(--overlay-weak);
  }

  .upload-drop-zone:hover,
  .upload-drop-zone.drag-over {
    border-color: var(--accent-gold);
    background: var(--glow-gold);
  }

  .upload-icon {
    font-size: 40px;
    margin-bottom: 12px;
    opacity: 0.7;
  }

  .upload-text {
    font-size: 14px;
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: 4px;
  }

  .upload-subtext {
    font-size: 12px;
    color: var(--text-muted);
  }

  .upload-status {
    font-size: 13px;
    padding: 10px 14px;
    border-radius: 8px;
    margin-bottom: 12px;
    min-height: 20px;
  }

  .upload-status:empty {
    display: none;
  }

  .upload-status.loading {
    color: var(--accent-blue);
    background: rgba(59, 130, 246, 0.1);
  }

  .upload-status.success {
    color: var(--accent-emerald);
    background: rgba(16, 185, 129, 0.1);
  }

  .upload-status.error {
    color: var(--accent-rose);
    background: rgba(244, 63, 94, 0.1);
  }

  .upload-actions {
    display: flex;
    gap: 10px;
    margin-bottom: 16px;
  }

  .upload-btn {
    flex: 1;
    padding: 10px 20px;
    border-radius: 8px;
    border: 1px solid var(--border-card);
    font-family: inherit;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .upload-btn-apply {
    background: var(--accent-gold);
    color: #000;
    border-color: var(--accent-gold);
  }

  .upload-btn-apply:hover {
    background: var(--accent-gold-light);
  }

  .upload-btn-cancel {
    background: var(--overlay-faint);
    color: var(--text-secondary);
  }

  .upload-btn-cancel:hover {
    background: var(--overlay-medium);
  }

  .export-actions {
    margin-bottom: 16px;
    padding: 12px;
    border-radius: 8px;
    background: rgba(250, 204, 21, 0.08);
    border: 1px solid rgba(250, 204, 21, 0.2);
  }

  .export-label {
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 8px;
    text-align: center;
  }

  .publish-btn {
    background: #238636 !important;
    color: #fff !important;
    border-color: #238636 !important;
    font-size: 13px !important;
    padding: 10px 12px !important;
  }

  .publish-btn:hover {
    background: #2ea043 !important;
  }

  .publish-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .publish-status {
    font-size: 12px;
    text-align: center;
    margin-top: 8px;
    min-height: 16px;
  }

  .publish-status.success { color: #10b981; }
  .publish-status.error { color: #f43f5e; }
  .publish-status.loading { color: var(--text-secondary); }

  .github-settings {
    margin-bottom: 12px;
    padding: 12px;
    border-radius: 8px;
    background: var(--overlay-faint);
    border: 1px solid var(--border-card);
  }

  .github-settings-title {
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 10px;
    color: var(--text-primary);
  }

  .github-settings-hint {
    font-weight: 400;
    color: var(--text-muted);
    font-size: 11px;
  }

  .github-label {
    display: block;
    font-size: 11px;
    color: var(--text-secondary);
    margin-bottom: 4px;
    margin-top: 8px;
  }

  .github-input {
    width: 100%;
    padding: 8px 10px;
    border-radius: 6px;
    border: 1px solid var(--border-card);
    background: var(--overlay-faint);
    color: var(--text-primary);
    font-family: inherit;
    font-size: 13px;
    box-sizing: border-box;
  }

  .github-input:focus {
    outline: none;
    border-color: var(--accent-gold);
  }

  .upload-reset {
    text-align: center;
    padding-top: 8px;
  }

  .upload-reset a {
    font-size: 12px;
    color: var(--text-muted);
    text-decoration: none;
  }

  .upload-reset a:hover {
    color: var(--accent-gold);
    text-decoration: underline;
  }

  .loading-overlay {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: fixed;
    inset: 0;
    z-index: 9999;
    background: light-dark(rgba(255,255,255,0.9), rgba(15,23,42,0.9));
    gap: 1rem;
  }
  .loading-spinner {
    width: 48px; height: 48px;
    border: 4px solid light-dark(#e2e8f0, #334155);
    border-top-color: var(--accent-gold);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-text {
    color: light-dark(#475569, #94a3b8);
    font-size: 1.1rem;
  }
  .data-error {
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: fixed;
    inset: 0;
    z-index: 9998;
    background: light-dark(rgba(255,255,255,0.95), rgba(15,23,42,0.95));
    gap: 1rem;
    text-align: center;
    padding: 2rem;
  }
  .data-error-icon { font-size: 3rem; }
  .data-error-message {
    color: light-dark(#475569, #94a3b8);
    font-size: 1.1rem;
    max-width: 400px;
  }
</style>
</head>
<body>

<div id="loading-overlay" class="loading-overlay">
  <div class="loading-spinner"></div>
  <div class="loading-text">Loading dashboard data...</div>
</div>
<div id="data-error" class="data-error" style="display:none;">
  <div class="data-error-icon">&#9888;</div>
  <div id="data-error-msg" class="data-error-message"></div>
  <button class="upload-btn" onclick="openUploadModal()">Upload Excel Data</button>
</div>

<div class="container">
  <!-- Header -->
  <div class="header fade-in">
    <div class="header-tools">
      <button class="theme-toggle" id="uploadBtn" onclick="openUploadModal()" title="Upload Excel data">&#128203;</button>
      <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="Toggle light/dark theme">&#9790;</button>
    </div>
    <div class="header-badge">Est. 2017 &bull; Weekly Tournaments</div>
    <h1>Ottawa Area Backgammon Club</h1>
    <p id="header-subtitle">Player Statistics &amp; Performance Dashboard &mdash; 396 Tournaments &bull; 85 Players &bull; 2017 &ndash; 2026</p>
    <p id="data-source-info" class="data-source-info">Data: Built-in defaults</p>
  </div>

  <!-- Summary Stats -->
  <div class="summary-row">
    <div class="summary-stat fade-in stagger-1" style="--stat-accent: var(--accent-gold);">
      <div class="number" id="stat-tournaments">286</div>
      <div class="label">Tournaments</div>
    </div>
    <div class="summary-stat fade-in stagger-2" style="--stat-accent: var(--accent-blue);">
      <div class="number" id="stat-players">60</div>
      <div class="label">Players</div>
    </div>
    <div class="summary-stat fade-in stagger-3" style="--stat-accent: var(--accent-emerald);">
      <div class="number" id="stat-games">4,208</div>
      <div class="label">Total Games</div>
    </div>
    <div class="summary-stat fade-in stagger-4" style="--stat-accent: var(--accent-purple);">
      <div class="number" id="stat-years">7</div>
      <div class="label">Seasons</div>
    </div>
  </div>

  <!-- Leaderboard Section -->
  <div class="leaderboard-section">
    <div class="leaderboard-grid">
      <!-- Left: Podium + Table -->
      <div class="card fade-in" style="padding-bottom: 16px;">
        <div class="card-title"><span class="dot" style="background: var(--accent-gold);"></span> All-Time Points Leaderboard</div>
        <div class="podium" id="podium"></div>
        <div class="table-rest">
          <div class="table-row table-header">
            <span class="rank">#</span>
            <span class="name">Player</span>
            <span class="stat-val">Points</span>
            <span class="stat-val">W-L</span>
            <span class="stat-val">PPT</span>
          </div>
          <div id="leaderboard-table"></div>
        </div>
      </div>

      <!-- Right: Horizontal bar chart -->
      <div class="card fade-in leaderboard-chart-wrap">
        <div class="card-title"><span class="dot" style="background: var(--accent-blue);"></span> Top 10 Points Breakdown</div>
        <div class="chart-container" style="min-height: 400px;">
          <canvas id="pointsBreakdownChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- 4 Mini Leaderboards -->
  <div class="stats-grid">
    <div class="card fade-in stagger-1">
      <div class="card-title"><span class="dot" style="background: var(--accent-emerald);"></span> Top 10 Win Rate</div>
      <div class="mini-board-note" style="font-size: 10px; color: var(--text-muted); margin-bottom: 12px; margin-top: -12px;">Min. 5 tournaments</div>
      <ul class="mini-board" id="board-winrate"></ul>
    </div>
    <div class="card fade-in stagger-2">
      <div class="card-title"><span class="dot" style="background: var(--accent-cyan);"></span> Top 10 Points/Tournament</div>
      <div class="mini-board-note" style="font-size: 10px; color: var(--text-muted); margin-bottom: 12px; margin-top: -12px;">Min. 5 tournaments</div>
      <ul class="mini-board" id="board-ppt"></ul>
    </div>
    <div class="card fade-in stagger-3">
      <div class="card-title"><span class="dot" style="background: var(--accent-purple);"></span> Top 10 % Placed</div>
      <div class="mini-board-note" style="font-size: 10px; color: var(--text-muted); margin-bottom: 12px; margin-top: -12px;">Min. 5 tournaments</div>
      <ul class="mini-board" id="board-placed"></ul>
    </div>
    <div class="card fade-in stagger-4">
      <div class="card-title"><span class="dot" style="background: var(--accent-orange);"></span> Top 10 Attendance</div>
      <ul class="mini-board" id="board-attendance"></ul>
    </div>
  </div>

  <!-- Cumulative Points & Attendance Charts -->
  <div class="charts-grid-2">
    <div class="card fade-in">
      <div class="card-title"><span class="dot" style="background: var(--accent-gold);"></span> Cumulative Points Over Years</div>
      <div class="chart-container">
        <canvas id="cumulativeChart"></canvas>
      </div>
    </div>
    <div class="card fade-in">
      <div class="card-title"><span class="dot" style="background: var(--accent-cyan);"></span> Weekly Attendance</div>
      <div class="chart-container">
        <canvas id="attendanceChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Win Rate & PPT Distribution -->
  <div class="charts-grid-2">
    <div class="card fade-in">
      <div class="card-title"><span class="dot" style="background: var(--accent-emerald);"></span> Win Rate Distribution</div>
      <div class="mini-board-note" style="font-size: 10px; color: var(--text-muted); margin-bottom: 8px; margin-top: -12px;">Players with 5+ tournaments</div>
      <div class="chart-container" style="min-height: 240px;">
        <canvas id="winRateDistChart"></canvas>
      </div>
    </div>
    <div class="card fade-in">
      <div class="card-title"><span class="dot" style="background: var(--accent-purple);"></span> Points Per Tournament Distribution</div>
      <div class="mini-board-note" style="font-size: 10px; color: var(--text-muted); margin-bottom: 8px; margin-top: -12px;">Players with 5+ tournaments</div>
      <div class="chart-container" style="min-height: 240px;">
        <canvas id="pptDistChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Year-over-Year + Attendance by Year -->
  <div class="charts-grid-2">
    <div class="card fade-in">
      <div class="card-title"><span class="dot" style="background: var(--accent-rose);"></span> Yearly Points &mdash; Top 5 Players</div>
      <div class="chart-container">
        <canvas id="yearlyPointsChart"></canvas>
      </div>
    </div>
    <div class="card fade-in">
      <div class="card-title"><span class="dot" style="background: var(--accent-blue);"></span> Club Growth &mdash; Yearly Overview</div>
      <div class="chart-container">
        <canvas id="yearlyOverviewChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Win/Loss Ratio Top 10 & Head-to-Head Radar -->
  <div class="charts-grid-2">
    <div class="card fade-in">
      <div class="card-title"><span class="dot" style="background: var(--accent-orange);"></span> Win vs Loss &mdash; Top 10 Players</div>
      <div class="chart-container">
        <canvas id="winLossChart"></canvas>
      </div>
    </div>
    <div class="card fade-in">
      <div class="card-title"><span class="dot" style="background: var(--accent-gold);"></span> Player Comparison Radar</div>
      <div class="filter-row" id="radar-filters"></div>
      <div class="chart-container">
        <canvas id="radarChart"></canvas>
      </div>
    </div>
  </div>

  <div class="footer">
    Ottawa Area Backgammon Club &bull; Data from March 2017 to February 2026 &bull; 396 Weekly Tournaments
  </div>
</div>

<!-- Player Detail Modal -->
<div class="modal-overlay" id="playerModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal()">&times;</button>
    <h2 id="modal-name"></h2>
    <div class="modal-subtitle" id="modal-subtitle"></div>
    <div class="modal-stats" id="modal-stats"></div>
    <div class="modal-chart">
      <canvas id="modalChart"></canvas>
    </div>
  </div>
</div>

<!-- Upload Modal -->
<div class="modal-overlay" id="uploadModal">
  <div class="modal" style="max-width: 480px;">
    <button class="modal-close" onclick="closeUploadModal()">&times;</button>
    <h2>Update Dashboard Data</h2>
    <div class="modal-subtitle">Upload the latest Excel spreadsheet to refresh all stats</div>
    <div class="upload-drop-zone" id="upload-drop-zone" onclick="document.getElementById('upload-file-input').click()">
      <div class="upload-icon">&#128196;</div>
      <div class="upload-text">Drag &amp; drop your Excel file here</div>
      <div class="upload-subtext">or click to browse</div>
      <input type="file" id="upload-file-input" accept=".xlsx,.xls" style="display:none" onchange="handleFileUpload(this.files[0])">
    </div>
    <div id="upload-status" class="upload-status"></div>
    <div id="upload-actions" class="upload-actions" style="display:none;">
      <button class="upload-btn upload-btn-apply" onclick="applyUploadedData()">Apply Data</button>
      <button class="upload-btn upload-btn-cancel" onclick="closeUploadModal()">Cancel</button>
    </div>
    <div id="publish-actions" class="export-actions" style="display:none;">
      <button class="upload-btn publish-btn" onclick="publishToGitHub()" style="width:100%" id="publish-btn">Publish</button>
      <div id="publish-status" class="publish-status"></div>
    </div>
    <div id="github-settings" class="github-settings" style="display:none;">
      <div class="github-settings-title">Connection Settings <span class="github-settings-hint">(one-time setup)</span></div>
      <label class="github-label">Repository</label>
      <input type="text" id="gh-repo" class="github-input" placeholder="e.g. JohnSmith/OttawaBackgammonClub">
      <label class="github-label">Access Token</label>
      <input type="password" id="gh-token" class="github-input" placeholder="ghp_xxxxxxxxxxxx">
      <button class="upload-btn upload-btn-apply" onclick="saveGitHubSettings()" style="width:100%; margin-top:8px;">Save Settings</button>
    </div>
    <div class="upload-reset">
      <a href="#" onclick="toggleGitHubSettings(); return false;" id="gh-settings-link">Settings</a>
    </div>
  </div>
</div>

<script>
// ===== DATA =====
let DEFAULT_DATA = null;
let DATA = null;

async function loadData() {
  // 1. Check localStorage first (user-uploaded Excel data)
  const stored = loadDataFromStorage();
  if (stored && stored.data) {
    DATA = stored.data;
    return;
  }

  // 2. Try fetching data.json (works on https://, not on file://)
  try {
    const resp = await fetch('data.json');
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    DEFAULT_DATA = await resp.json();
    DATA = DEFAULT_DATA;
    return;
  } catch (e) {
    console.warn('Could not fetch data.json:', e.message);
  }

  // 3. Fallback: inject <script src=data.js> (works on file://)
  try {
    await new Promise((resolve, reject) => {
      const s = document.createElement('script');
      s.src = 'data.js';
      s.onload = resolve;
      s.onerror = reject;
      document.head.appendChild(s);
    });
    if (window.__BACKGAMMON_DATA__) {
      DEFAULT_DATA = window.__BACKGAMMON_DATA__;
      DATA = DEFAULT_DATA;
      return;
    }
  } catch (e) {
    console.warn('Could not load data.js fallback:', e.message);
  }

  // 4. If everything fails, show error
  throw new Error('No data available. Please upload an Excel file.');
}

// ===== COLORS =====
const COLORS = {
  gold: '#f59e0b', blue: '#3b82f6', cyan: '#06b6d4', emerald: '#10b981',
  purple: '#8b5cf6', rose: '#f43f5e', orange: '#f97316', lime: '#84cc16',
  pink: '#ec4899', teal: '#14b8a6'
};
const PALETTE = [COLORS.gold, COLORS.blue, COLORS.cyan, COLORS.emerald, COLORS.purple, COLORS.rose, COLORS.orange, COLORS.lime, COLORS.pink, COLORS.teal];
const PALETTE_BG = PALETTE.map(c => c + '33');

// ===== HELPERS =====
let players, byPoints, qualified, byWinPct, byPPT, byPlaced, byAttendance;
const minT = 5;

function deriveData() {
  players = DATA.players;
  byPoints = [...players].sort((a, b) => b.total_points - a.total_points);
  qualified = players.filter(p => p.tournaments >= minT);
  byWinPct = [...qualified].sort((a, b) => b.win_pct - a.win_pct);
  byPPT = [...qualified].sort((a, b) => b.ppt - a.ppt);
  byPlaced = [...qualified].sort((a, b) => b.placed_pct - a.placed_pct);
  byAttendance = [...players].sort((a, b) => b.tournaments - a.tournaments);
}

function initials(name) {
  return name.split(' ').map(w => w[0]).join('').toUpperCase().slice(0, 2);
}

function firstName(name) {
  const parts = name.split(' ');
  return parts.length > 1 ? parts[0] + ' ' + parts[parts.length - 1][0] + '.' : name;
}

// ===== LOCAL STORAGE =====
function saveDataToStorage(data, fileName) {
  try {
    localStorage.setItem('bgclub-data', JSON.stringify({
      data, fileName, uploadedAt: new Date().toISOString()
    }));
  } catch (e) { /* quota exceeded -- data will not persist */ }
}

function loadDataFromStorage() {
  try {
    const stored = localStorage.getItem('bgclub-data');
    return stored ? JSON.parse(stored) : null;
  } catch (e) { return null; }
}

function clearStoredData() {
  localStorage.removeItem('bgclub-data');
}

// ===== DATA SOURCE INDICATOR =====
function updateDataSourceInfo() {
  const el = document.getElementById('data-source-info');
  if (!el) return;
  const stored = loadDataFromStorage();
  if (stored && stored.data) {
    const d = new Date(stored.uploadedAt);
    const dateStr = d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    el.innerHTML = `Data: <strong>${stored.fileName}</strong> (uploaded ${dateStr})`;
  } else {
    el.textContent = 'Data: Default dataset (data.json)';
  }
  // Update subtitle counts
  const dates = Object.keys(DATA.attendance).sort();
  const firstYear = dates[0] ? dates[0].slice(0, 4) : '?';
  const lastYear = dates[dates.length - 1] ? dates[dates.length - 1].slice(0, 4) : '?';
  document.getElementById('header-subtitle').innerHTML =
    `Player Statistics &amp; Performance Dashboard &mdash; ${DATA.total_tournaments} Tournaments &bull; ${DATA.players.length} Players &bull; ${firstYear} &ndash; ${lastYear}`;
}

// ===== EXCEL PARSER =====
function parseExcelToData(workbook) {
  // Find the data sheet (try "Club Points" first, else first sheet)
  let sheetName = workbook.SheetNames.find(n => n.toLowerCase().includes('club') || n.toLowerCase().includes('point'));
  if (!sheetName) sheetName = workbook.SheetNames[0];
  const sheet = workbook.Sheets[sheetName];
  const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: null });

  if (rows.length < 2) throw new Error('Spreadsheet appears empty');

  // Find header row (look for "Date" and "Player" columns)
  let headerIdx = 0;
  for (let i = 0; i < Math.min(5, rows.length); i++) {
    const row = rows[i];
    if (row && row.some(c => String(c).toLowerCase() === 'date') && row.some(c => String(c).toLowerCase() === 'player')) {
      headerIdx = i;
      break;
    }
  }

  const header = rows[headerIdx].map(h => String(h || '').trim().toLowerCase());
  const dateCol = header.findIndex(h => h === 'date');
  const playerCol = header.findIndex(h => h === 'player');
  const winsCol = header.findIndex(h => h === 'wins');
  const lossesCol = header.findIndex(h => h.startsWith('lose') || h.startsWith('loss'));
  const placingCol = header.findIndex(h => h.includes('placing') || h.includes('points for'));

  if (dateCol < 0 || playerCol < 0) throw new Error('Could not find "Date" and "Player" columns');
  if (winsCol < 0) throw new Error('Could not find "Wins" column');
  if (lossesCol < 0) throw new Error('Could not find "Losses" column');

  // Parse data rows
  const dataRows = rows.slice(headerIdx + 1);
  const tournamentDates = new Set();
  const playerMap = {};      // player -> { wins, losses, placing_pts, tournamentsSet, yearlyMap }
  const attendance = {};     // dateStr -> count

  for (const row of dataRows) {
    if (!row || !row[dateCol] || !row[playerCol]) continue;

    // Parse date
    let dateVal = row[dateCol];
    let dateStr;
    if (dateVal instanceof Date) {
      dateStr = dateVal.toISOString().slice(0, 10);
    } else if (typeof dateVal === 'number') {
      // Excel serial date
      const d = XLSX.SSF.parse_date_code(dateVal);
      dateStr = `${d.y}-${String(d.m).padStart(2, '0')}-${String(d.d).padStart(2, '0')}`;
    } else {
      dateStr = String(dateVal).trim().slice(0, 10);
    }
    if (!/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) continue;

    const name = String(row[playerCol]).trim();
    if (!name) continue;

    const wins = Number(row[winsCol]) || 0;
    const losses = Number(row[lossesCol]) || 0;
    const placing = (placingCol >= 0 && row[placingCol] != null && String(row[placingCol]).trim() !== '')
      ? Number(row[placingCol]) || 0 : 0;

    const year = dateStr.slice(0, 4);
    tournamentDates.add(dateStr);

    if (!attendance[dateStr]) attendance[dateStr] = 0;
    attendance[dateStr]++;

    if (!playerMap[name]) {
      playerMap[name] = { wins: 0, losses: 0, placing_pts: 0, tournamentsSet: new Set(), placed_dates: new Set(), yearlyMap: {} };
    }
    const p = playerMap[name];
    p.wins += wins;
    p.losses += losses;
    p.placing_pts += placing;
    p.tournamentsSet.add(dateStr);
    if (placing > 0) p.placed_dates.add(dateStr);

    if (!p.yearlyMap[year]) p.yearlyMap[year] = { tournaments: new Set(), wins: 0, losses: 0, placing_pts: 0, placed: new Set() };
    const ym = p.yearlyMap[year];
    ym.tournaments.add(dateStr);
    ym.wins += wins;
    ym.losses += losses;
    ym.placing_pts += placing;
    if (placing > 0) ym.placed.add(dateStr);
  }

  const total_tournaments = tournamentDates.size;
  const sortedDates = [...tournamentDates].sort();
  const yearsSet = new Set(sortedDates.map(d => d.slice(0, 4)));
  const years = [...yearsSet].sort();

  // Build players array
  const playersArr = Object.entries(playerMap).map(([name, p]) => {
    const tournaments = p.tournamentsSet.size;
    const total_games = p.wins + p.losses;
    const total_points = p.wins + p.placing_pts;
    const win_pct = total_games > 0 ? +((p.wins / total_games) * 100).toFixed(1) : 0;
    const ppt = tournaments > 0 ? +(total_points / tournaments).toFixed(2) : 0;
    const placed_count = p.placed_dates.size;
    const placed_pct = tournaments > 0 ? +((placed_count / tournaments) * 100).toFixed(1) : 0;
    const participation_pct = total_tournaments > 0 ? +((tournaments / total_tournaments) * 100).toFixed(1) : 0;
    return { player: name, total_points, wins: p.wins, losses: p.losses, total_games, win_pct, tournaments, ppt, placed_count, placed_pct, placing_pts: p.placing_pts, participation_pct };
  });

  // Sort by total_points desc for top 10 selection
  const sortedByPoints = [...playersArr].sort((a, b) => b.total_points - a.total_points);
  const top10Names = sortedByPoints.slice(0, 10).map(p => p.player);

  // Build yearly_performance for top 10
  const yearly_performance = {};
  for (const name of top10Names) {
    const p = playerMap[name];
    yearly_performance[name] = years.map(y => {
      const ym = p.yearlyMap[y];
      if (!ym || ym.tournaments.size === 0) return { year: y, tournaments: 0, wins: 0, losses: 0, points: 0, ppt: 0, win_pct: 0 };
      const t = ym.tournaments.size;
      const pts = ym.wins + ym.placing_pts;
      const games = ym.wins + ym.losses;
      return {
        year: y, tournaments: t, wins: ym.wins, losses: ym.losses,
        points: pts, ppt: t > 0 ? +(pts / t).toFixed(2) : 0,
        win_pct: games > 0 ? +((ym.wins / games) * 100).toFixed(1) : 0
      };
    });
  }

  // Build cumulative for top 10
  const cumulative = {};
  for (const name of top10Names) {
    let running = 0;
    cumulative[name] = years.map(y => {
      const yp = yearly_performance[name].find(yy => yy.year === y);
      running += yp ? yp.points : 0;
      return { year: y, cumulative: running };
    });
  }

  return { players: playersArr, total_tournaments, attendance, cumulative, yearly_performance, years };
}

// ===== REBUILD =====
function rebuildAll() {
  deriveData();
  buildPodium();
  buildLeaderboardTable();
  // Reset radar selection to top 3 from new data
  radarSelected.clear();
  byPoints.slice(0, 3).forEach(p => radarSelected.add(p.player));
  buildRadarFilters();
  rebuildCharts();
  const totalGames = players.reduce((s, p) => s + p.total_games, 0);
  animateNumber(document.getElementById('stat-tournaments'), DATA.total_tournaments);
  animateNumber(document.getElementById('stat-players'), DATA.players.length);
  animateNumber(document.getElementById('stat-games'), totalGames);
  animateNumber(document.getElementById('stat-years'), DATA.years.length);
  updateDataSourceInfo();
}


// ===== GITHUB PUBLISH =====
function getGitHubSettings() {
  try {
    const s = localStorage.getItem('bgclub-github');
    return s ? JSON.parse(s) : null;
  } catch { return null; }
}

function saveGitHubSettings() {
  const repo = document.getElementById('gh-repo').value.trim();
  const token = document.getElementById('gh-token').value.trim();
  if (!repo || !token) {
    alert('Both repository and token are required.');
    return;
  }
  if (!repo.includes('/')) {
    alert('Repository must be in owner/repo format (e.g. JohnSmith/OttawaBackgammonClub)');
    return;
  }
  localStorage.setItem('bgclub-github', JSON.stringify({ repo, token }));
  document.getElementById('github-settings').style.display = 'none';
  showPublishStatus('Settings saved!', 'success');
  updatePublishUI();
}

function toggleGitHubSettings() {
  const el = document.getElementById('github-settings');
  const visible = el.style.display !== 'none';
  el.style.display = visible ? 'none' : 'block';
  if (!visible) {
    const settings = getGitHubSettings();
    if (settings) {
      document.getElementById('gh-repo').value = settings.repo;
      document.getElementById('gh-token').value = settings.token;
    }
  }
}

function showPublishStatus(msg, type) {
  const el = document.getElementById('publish-status');
  if (el) { el.textContent = msg; el.className = 'publish-status ' + (type || ''); }
}

function updatePublishUI() {
  const el = document.getElementById('publish-actions');
  if (el) el.style.display = getGitHubSettings() ? 'block' : 'none';
}

function showPublishActions(show) {
  if (show && getGitHubSettings()) {
    document.getElementById('publish-actions').style.display = 'block';
  }
  showPublishStatus('', '');
}

async function publishToGitHub() {
  const settings = getGitHubSettings();
  if (!settings) {
    toggleGitHubSettings();
    return;
  }

  const btn = document.getElementById('publish-btn');
  btn.disabled = true;
  btn.textContent = 'Publishing...';
  showPublishStatus('Publishing...', 'loading');

  try {
    const { repo, token } = settings;
    const apiBase = 'https://api.github.com/repos/' + repo + '/contents/data.json';
    const headers = {
      'Authorization': 'Bearer ' + token,
      'Accept': 'application/vnd.github.v3+json',
      'Content-Type': 'application/json'
    };

    // Get current file SHA (needed to update existing file)
    let sha = null;
    try {
      const existing = await fetch(apiBase, { headers });
      if (existing.ok) {
        const info = await existing.json();
        sha = info.sha;
      }
    } catch {}

    // Encode content as base64
    const content = JSON.stringify(DATA, null, 2);
    const base64 = btoa(unescape(encodeURIComponent(content)));

    const body = {
      message: 'Update data.json â€” ' + new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }),
      content: base64
    };
    if (sha) body.sha = sha;

    const resp = await fetch(apiBase, { method: 'PUT', headers, body: JSON.stringify(body) });

    if (!resp.ok) {
      const err = await resp.json().catch(() => ({}));
      throw new Error(err.message || 'HTTP ' + resp.status);
    }

    clearStoredData();
    showPublishStatus('Published! The site will update in about a minute.', 'success');
  } catch (e) {
    showPublishStatus('Error: ' + e.message, 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Publish';
  }
}

// ===== UPLOAD MODAL =====
let pendingParsedData = null;

function openUploadModal() {
  document.getElementById('uploadModal').classList.add('active');
  document.getElementById('upload-status').innerHTML = '';
  document.getElementById('upload-actions').style.display = 'none';
  document.getElementById('upload-file-input').value = '';
  pendingParsedData = null;
  document.getElementById('publish-actions').style.display = 'none';
  document.getElementById('github-settings').style.display = 'none';
  showPublishStatus('', '');
}

function closeUploadModal() {
  document.getElementById('uploadModal').classList.remove('active');
  pendingParsedData = null;
}

function handleFileUpload(file) {
  if (!file) return;
  const ext = file.name.split('.').pop().toLowerCase();
  if (!['xlsx', 'xls'].includes(ext)) {
    showUploadStatus('Please select an Excel file (.xlsx or .xls)', 'error');
    return;
  }
  showUploadStatus('Parsing spreadsheet...', 'loading');
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const wb = XLSX.read(e.target.result, { type: 'array', cellDates: true });
      const parsed = parseExcelToData(wb);
      pendingParsedData = { data: parsed, fileName: file.name };
      showUploadStatus(
        `Found <strong>${parsed.players.length} players</strong> across <strong>${parsed.total_tournaments} tournaments</strong> (${parsed.years[0]}&ndash;${parsed.years[parsed.years.length - 1]})`,
        'success'
      );
      document.getElementById('upload-actions').style.display = 'flex';
    } catch (err) {
      showUploadStatus('Error: ' + err.message, 'error');
      document.getElementById('upload-actions').style.display = 'none';
    }
  };
  reader.readAsArrayBuffer(file);
}

function showUploadStatus(msg, type) {
  const el = document.getElementById('upload-status');
  el.innerHTML = msg;
  el.className = 'upload-status ' + (type || '');
}

function applyUploadedData() {
  if (!pendingParsedData) return;
  DATA = pendingParsedData.data;
  saveDataToStorage(pendingParsedData.data, pendingParsedData.fileName);
  rebuildAll();
  document.getElementById('upload-actions').style.display = 'none';
  showUploadStatus('Data applied successfully!', 'success');
  showPublishActions(true);
}

// ===== THEME =====
function isDark() {
  return document.documentElement.style.colorScheme !== 'light';
}

function applyChartDefaults() {
  const dark = isDark();
  Chart.defaults.color = dark ? '#94a3b8' : '#475569';
  Chart.defaults.font.family = "'Inter', sans-serif";
  Chart.defaults.font.size = 11;
  Chart.defaults.plugins.legend.labels.usePointStyle = true;
  Chart.defaults.plugins.legend.labels.pointStyleWidth = 10;
  Chart.defaults.plugins.tooltip.backgroundColor = dark ? 'rgba(15, 23, 42, 0.95)' : 'rgba(255, 255, 255, 0.95)';
  Chart.defaults.plugins.tooltip.titleColor = dark ? '#f1f5f9' : '#1e293b';
  Chart.defaults.plugins.tooltip.bodyColor = dark ? '#cbd5e1' : '#475569';
  Chart.defaults.plugins.tooltip.borderColor = dark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
  Chart.defaults.plugins.tooltip.borderWidth = 1;
  Chart.defaults.plugins.tooltip.cornerRadius = 8;
  Chart.defaults.plugins.tooltip.padding = 12;
  Chart.defaults.plugins.tooltip.titleFont = { size: 13, weight: '600' };
  Chart.defaults.plugins.tooltip.bodyFont = { size: 12 };
  Chart.defaults.scale.grid.color = dark ? 'rgba(255, 255, 255, 0.04)' : 'rgba(0, 0, 0, 0.06)';
  Chart.defaults.scale.border.color = dark ? 'rgba(255, 255, 255, 0.06)' : 'rgba(0, 0, 0, 0.08)';
}

function toggleTheme() {
  const goLight = isDark();
  document.documentElement.style.colorScheme = goLight ? 'light' : 'dark';
  document.getElementById('themeToggle').innerHTML = goLight ? '&#9728;' : '&#9790;';
  localStorage.setItem('theme', goLight ? 'light' : 'dark');
  rebuildCharts();
}

function restoreTheme() {
  const saved = localStorage.getItem('theme');
  if (saved === 'light') {
    document.documentElement.style.colorScheme = 'light';
    document.getElementById('themeToggle').innerHTML = '&#9728;';
  }
}

function rebuildCharts() {
  // Destroy all existing charts
  Chart.helpers.each(Chart.instances, (chart) => chart.destroy());
  applyChartDefaults();
  buildAllMiniBoards();
  buildPointsBreakdown();
  buildCumulativeChart();
  buildAttendanceChart();
  buildWinRateDistribution();
  buildPPTDistribution();
  buildYearlyPoints();
  buildYearlyOverview();
  buildWinLossChart();
  radarChart = null;
  updateRadar();
}

applyChartDefaults();

// ===== 1. PODIUM =====
function buildPodium() {
  const top3 = byPoints.slice(0, 3);
  const order = [top3[1], top3[0], top3[2]]; // 2nd, 1st, 3rd
  const podiumEl = document.getElementById('podium');
  podiumEl.innerHTML = order.map((p, i) => {
    const rank = i === 1 ? 1 : i === 0 ? 2 : 3;
    const crown = rank === 1 ? '<span class="crown">&#9813;</span>' : '';
    return `
      <div class="podium-slot clickable" onclick="openModal('${p.player}')">
        <div class="podium-avatar">${crown}${initials(p.player)}</div>
        <div class="podium-name">${p.player}</div>
        <div class="podium-pts">${Math.round(p.total_points)}</div>
        <div class="podium-sub">${p.wins}W - ${p.losses}L</div>
        <div class="podium-bar"></div>
      </div>`;
  }).join('');
}

// ===== 2. LEADERBOARD TABLE (4-10) =====
function buildLeaderboardTable() {
  const rest = byPoints.slice(3, 10);
  const el = document.getElementById('leaderboard-table');
  el.innerHTML = rest.map((p, i) => `
    <div class="table-row clickable" onclick="openModal('${p.player}')">
      <span class="rank">${i + 4}</span>
      <span class="name">${p.player}</span>
      <span class="stat-val" style="color: var(--accent-gold);">${Math.round(p.total_points)}</span>
      <span class="stat-val" style="color: var(--text-secondary);">${p.wins}-${p.losses}</span>
      <span class="stat-val" style="color: var(--accent-cyan);">${p.ppt}</span>
    </div>`).join('');
}

// ===== 3. POINTS BREAKDOWN CHART =====
function buildPointsBreakdown() {
  const top10 = byPoints.slice(0, 10);
  new Chart(document.getElementById('pointsBreakdownChart'), {
    type: 'bar',
    data: {
      labels: top10.map(p => firstName(p.player)),
      datasets: [
        {
          label: 'Wins',
          data: top10.map(p => p.wins),
          backgroundColor: COLORS.blue + 'cc',
          borderRadius: 4,
          borderSkipped: false,
        },
        {
          label: 'Placing Bonus',
          data: top10.map(p => p.placing_pts),
          backgroundColor: COLORS.gold + 'cc',
          borderRadius: 4,
          borderSkipped: false,
        }
      ]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'top', align: 'end' },
        tooltip: {
          callbacks: {
            afterBody: (ctx) => {
              const idx = ctx[0].dataIndex;
              const p = top10[idx];
              return `Total: ${Math.round(p.total_points)} pts`;
            }
          }
        }
      },
      scales: {
        x: {
          stacked: true,
          title: { display: true, text: 'Points' }
        },
        y: {
          stacked: true,
          ticks: { font: { weight: '500' } }
        }
      }
    }
  });
}

// ===== 4. MINI BOARDS =====
function buildMiniBoard(elId, data, valFn, subFn, color, count = 10) {
  const el = document.getElementById(elId);
  const dark = isDark();
  const rankColors = ['rgba(245,158,11,0.2)', 'rgba(148,163,184,0.15)', 'rgba(217,119,6,0.15)',
    dark ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.05)', dark ? 'rgba(255,255,255,0.04)' : 'rgba(0,0,0,0.03)'];
  el.innerHTML = data.slice(0, count).map((p, i) => `
    <li class="clickable" onclick="openModal('${p.player}')">
      <div class="mini-left">
        <span class="mini-rank" style="background: ${rankColors[i] || rankColors[4]}; color: ${i < 3 ? color : 'var(--text-muted)'};">${i + 1}</span>
        <span class="mini-name">${p.player}</span>
      </div>
      <div class="mini-right">
        <span class="mini-val" style="color: ${color};">${valFn(p)}</span>
        <span class="mini-sub">${subFn(p)}</span>
      </div>
    </li>`).join('');
}

function buildAllMiniBoards() {
  buildMiniBoard('board-winrate', byWinPct,
    p => p.win_pct + '%',
    p => `${p.wins}W/${p.losses}L`,
    'var(--accent-emerald)'
  );
  buildMiniBoard('board-ppt', byPPT,
    p => p.ppt.toFixed(2),
    p => `${p.tournaments} tourn.`,
    'var(--accent-cyan)'
  );
  buildMiniBoard('board-placed', byPlaced,
    p => p.placed_pct + '%',
    p => `${p.placed_count}/${p.tournaments}`,
    'var(--accent-purple)'
  );
  buildMiniBoard('board-attendance', byAttendance,
    p => p.tournaments.toString(),
    p => `${p.participation_pct}%`,
    'var(--accent-orange)',
    10
  );
}

// ===== 5. CUMULATIVE CHART =====
function buildCumulativeChart() {
  const years = DATA.years;
  const datasets = Object.entries(DATA.cumulative).map(([name, series], i) => ({
    label: firstName(name),
    data: series.map(s => s.cumulative),
    borderColor: PALETTE[i],
    backgroundColor: PALETTE[i] + '15',
    borderWidth: 2.5,
    pointRadius: 4,
    pointHoverRadius: 7,
    pointBackgroundColor: PALETTE[i],
    tension: 0.3,
    fill: false,
  }));

  new Chart(document.getElementById('cumulativeChart'), {
    type: 'line',
    data: { labels: years, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { position: 'bottom', labels: { padding: 16, font: { size: 10 } } }
      },
      scales: {
        y: { title: { display: true, text: 'Cumulative Points' } }
      }
    }
  });
}

// ===== 6. ATTENDANCE CHART =====
function buildAttendanceChart() {
  const dates = Object.keys(DATA.attendance).sort();
  const values = dates.map(d => DATA.attendance[d]);
  const avg = values.reduce((a, b) => a + b, 0) / values.length;

  // Group by quarter for cleaner view
  const quarterData = {};
  dates.forEach((d, i) => {
    const [y, m] = d.split('-');
    const q = `${y} Q${Math.ceil(parseInt(m) / 3)}`;
    if (!quarterData[q]) quarterData[q] = [];
    quarterData[q].push(values[i]);
  });

  const quarterLabels = Object.keys(quarterData);
  const quarterAvg = quarterLabels.map(q => {
    const vals = quarterData[q];
    return +(vals.reduce((a, b) => a + b, 0) / vals.length).toFixed(1);
  });

  new Chart(document.getElementById('attendanceChart'), {
    type: 'bar',
    data: {
      labels: quarterLabels,
      datasets: [
        {
          label: 'Avg Players/Week',
          data: quarterAvg,
          backgroundColor: quarterLabels.map(q => {
            const yr = parseInt(q);
            const colors = { 2017: COLORS.blue, 2018: COLORS.cyan, 2019: COLORS.emerald, 2020: COLORS.rose, 2021: COLORS.purple, 2022: COLORS.orange, 2023: COLORS.gold, 2024: COLORS.lime, 2025: COLORS.pink, 2026: COLORS.teal };
            return (colors[yr] || COLORS.blue) + '99';
          }),
          borderRadius: 4,
          borderSkipped: false,
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (ctx) => `Avg: ${ctx.raw} players/week`
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: { display: true, text: 'Players per Week' }
        },
        x: {
          ticks: { maxRotation: 45, font: { size: 9 } }
        }
      }
    }
  });
}

// ===== 7. WIN RATE DISTRIBUTION =====
function buildWinRateDistribution() {
  const buckets = ['0-20%', '20-30%', '30-40%', '40-50%', '50-60%', '60-70%', '70%+'];
  const bucketRanges = [[0,20],[20,30],[30,40],[40,50],[50,60],[60,70],[70,101]];
  const counts = bucketRanges.map(([lo, hi]) => qualified.filter(p => p.win_pct >= lo && p.win_pct < hi).length);

  const gradColors = ['#f43f5e', '#f97316', '#f59e0b', '#eab308', '#84cc16', '#10b981', '#06b6d4'];

  new Chart(document.getElementById('winRateDistChart'), {
    type: 'bar',
    data: {
      labels: buckets,
      datasets: [{
        label: 'Players',
        data: counts,
        backgroundColor: gradColors.map(c => c + 'bb'),
        borderRadius: 6,
        borderSkipped: false,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            afterLabel: (ctx) => {
              const [lo, hi] = bucketRanges[ctx.dataIndex];
              const names = qualified.filter(p => p.win_pct >= lo && p.win_pct < hi).map(p => `${p.player} (${p.win_pct}%)`);
              return names.length <= 6 ? names.join('\n') : names.slice(0, 5).join('\n') + `\n+${names.length - 5} more`;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { stepSize: 1 },
          title: { display: true, text: 'Players' }
        }
      }
    }
  });
}

// ===== 8. PPT DISTRIBUTION =====
function buildPPTDistribution() {
  const buckets = ['0-0.5', '0.5-1.0', '1.0-1.5', '1.5-2.0', '2.0-2.5', '2.5-3.0', '3.0+'];
  const bucketRanges = [[0,0.5],[0.5,1],[1,1.5],[1.5,2],[2,2.5],[2.5,3],[3,10]];
  const counts = bucketRanges.map(([lo, hi]) => qualified.filter(p => p.ppt >= lo && p.ppt < hi).length);

  const gradColors = ['#64748b', '#8b5cf6', '#6366f1', '#3b82f6', '#06b6d4', '#10b981', '#f59e0b'];

  new Chart(document.getElementById('pptDistChart'), {
    type: 'bar',
    data: {
      labels: buckets,
      datasets: [{
        label: 'Players',
        data: counts,
        backgroundColor: gradColors.map(c => c + 'bb'),
        borderRadius: 6,
        borderSkipped: false,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            afterLabel: (ctx) => {
              const [lo, hi] = bucketRanges[ctx.dataIndex];
              const names = qualified.filter(p => p.ppt >= lo && p.ppt < hi).map(p => `${p.player} (${p.ppt})`);
              return names.length <= 6 ? names.join('\n') : names.slice(0, 5).join('\n') + `\n+${names.length - 5} more`;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { stepSize: 1 },
          title: { display: true, text: 'Players' }
        }
      }
    }
  });
}

// ===== 9. YEARLY POINTS (Top 5) =====
function buildYearlyPoints() {
  const top5 = Object.keys(DATA.yearly_performance).slice(0, 5);
  const years = DATA.years;

  new Chart(document.getElementById('yearlyPointsChart'), {
    type: 'line',
    data: {
      labels: years,
      datasets: top5.map((name, i) => ({
        label: firstName(name),
        data: DATA.yearly_performance[name].map(y => y.points),
        borderColor: PALETTE[i],
        backgroundColor: PALETTE[i] + '22',
        borderWidth: 2,
        pointRadius: 3,
        pointHoverRadius: 6,
        tension: 0.3,
        fill: false,
      }))
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom', labels: { padding: 12, font: { size: 10 } } }
      },
      scales: {
        y: { title: { display: true, text: 'Points' } }
      }
    }
  });
}

// ===== 10. CLUB YEARLY OVERVIEW =====
function buildYearlyOverview() {
  const yearlyStats = DATA.years.map(y => {
    const yearDates = Object.keys(DATA.attendance).filter(d => d.startsWith(y));
    const totalAttendance = yearDates.reduce((s, d) => s + DATA.attendance[d], 0);
    const avgAttendance = totalAttendance / yearDates.length;
    return { year: y, tournaments: yearDates.length, avgAttendance: +avgAttendance.toFixed(1) };
  });

  new Chart(document.getElementById('yearlyOverviewChart'), {
    type: 'bar',
    data: {
      labels: DATA.years,
      datasets: [
        {
          label: 'Tournaments',
          data: yearlyStats.map(y => y.tournaments),
          backgroundColor: COLORS.blue + 'bb',
          borderRadius: 4,
          borderSkipped: false,
          yAxisID: 'y',
        },
        {
          label: 'Avg Attendance',
          data: yearlyStats.map(y => y.avgAttendance),
          type: 'line',
          borderColor: COLORS.gold,
          backgroundColor: COLORS.gold + '22',
          borderWidth: 2.5,
          pointRadius: 5,
          pointBackgroundColor: COLORS.gold,
          tension: 0.3,
          yAxisID: 'y1',
          fill: true,
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom', labels: { padding: 12 } }
      },
      scales: {
        y: {
          position: 'left',
          title: { display: true, text: 'Tournaments' },
          beginAtZero: true,
        },
        y1: {
          position: 'right',
          title: { display: true, text: 'Avg Players/Week' },
          beginAtZero: true,
          grid: { drawOnChartArea: false },
        }
      }
    }
  });
}

// ===== 11. WIN vs LOSS CHART =====
function buildWinLossChart() {
  const top10 = byPoints.slice(0, 10);

  new Chart(document.getElementById('winLossChart'), {
    type: 'bar',
    data: {
      labels: top10.map(p => firstName(p.player)),
      datasets: [
        {
          label: 'Wins',
          data: top10.map(p => p.wins),
          backgroundColor: COLORS.emerald + 'cc',
          borderRadius: 4,
          borderSkipped: false,
        },
        {
          label: 'Losses',
          data: top10.map(p => -p.losses),
          backgroundColor: COLORS.rose + '99',
          borderRadius: 4,
          borderSkipped: false,
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'top', align: 'end' },
        tooltip: {
          callbacks: {
            label: (ctx) => {
              const val = Math.abs(ctx.raw);
              return `${ctx.dataset.label}: ${val}`;
            },
            afterBody: (ctx) => {
              const idx = ctx[0].dataIndex;
              const p = top10[idx];
              return `Win Rate: ${p.win_pct}%`;
            }
          }
        }
      },
      scales: {
        x: { stacked: true },
        y: {
          stacked: true,
          ticks: {
            callback: v => Math.abs(v)
          },
          title: { display: true, text: 'Games' }
        }
      }
    }
  });
}

// ===== 12. RADAR CHART =====
let radarChart = null;
const radarSelected = new Set();

function buildRadarFilters() {
  const el = document.getElementById('radar-filters');
  const top10 = byPoints.slice(0, 10);
  el.innerHTML = top10.map(p => {
    const active = radarSelected.has(p.player) ? 'active' : '';
    return `<button class="filter-btn ${active}" data-player="${p.player}" onclick="toggleRadarPlayer(this)">${firstName(p.player)}</button>`;
  }).join('');
}

function toggleRadarPlayer(btn) {
  const name = btn.dataset.player;
  if (radarSelected.has(name)) {
    radarSelected.delete(name);
    btn.classList.remove('active');
  } else {
    radarSelected.add(name);
    btn.classList.add('active');
  }
  updateRadar();
}

function updateRadar() {
  const selected = [...radarSelected].map(name => players.find(p => p.player === name)).filter(Boolean);
  if (!selected.length) return;

  // Normalize metrics to 0-100 scale
  const maxPts = Math.max(...players.map(p => p.total_points));
  const maxT = Math.max(...players.map(p => p.tournaments));
  const maxPPT = Math.max(...qualified.map(p => p.ppt));

  const labels = ['Win Rate', 'PPT', 'Total Points', 'Attendance', 'Placed %', 'Games Played'];

  const datasets = selected.map((p, i) => {
    const idx = byPoints.findIndex(bp => bp.player === p.player);
    const color = PALETTE[idx] || PALETTE[i];
    return {
      label: firstName(p.player),
      data: [
        p.win_pct,
        (p.ppt / maxPPT) * 100,
        (p.total_points / maxPts) * 100,
        p.participation_pct,
        p.placed_pct,
        (p.total_games / Math.max(...players.map(x => x.total_games))) * 100,
      ],
      borderColor: color,
      backgroundColor: color + '22',
      borderWidth: 2,
      pointRadius: 4,
      pointBackgroundColor: color,
    };
  });

  if (radarChart) radarChart.destroy();
  radarChart = new Chart(document.getElementById('radarChart'), {
    type: 'radar',
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom', labels: { padding: 12, font: { size: 10 } } }
      },
      scales: {
        r: {
          beginAtZero: true,
          max: 100,
          ticks: { stepSize: 20, color: isDark() ? '#64748b' : '#64748b', backdropColor: 'transparent', font: { size: 9 } },
          grid: { color: isDark() ? 'rgba(255, 255, 255, 0.06)' : 'rgba(0, 0, 0, 0.08)' },
          angleLines: { color: isDark() ? 'rgba(255, 255, 255, 0.06)' : 'rgba(0, 0, 0, 0.08)' },
          pointLabels: { color: isDark() ? '#94a3b8' : '#374151', font: { size: 11, weight: '500' } }
        }
      }
    }
  });
}

// ===== 13. PLAYER MODAL =====
let modalChart = null;

function openModal(playerName) {
  const p = players.find(x => x.player === playerName);
  if (!p) return;

  document.getElementById('modal-name').textContent = p.player;
  document.getElementById('modal-subtitle').textContent = `${p.tournaments} tournaments attended | ${p.total_games} games played`;

  document.getElementById('modal-stats').innerHTML = `
    <div class="modal-stat"><div class="ms-val" style="color: var(--accent-gold);">${Math.round(p.total_points)}</div><div class="ms-label">Total Points</div></div>
    <div class="modal-stat"><div class="ms-val" style="color: var(--accent-emerald);">${p.win_pct}%</div><div class="ms-label">Win Rate</div></div>
    <div class="modal-stat"><div class="ms-val" style="color: var(--accent-cyan);">${p.ppt}</div><div class="ms-label">Points/Tournament</div></div>
    <div class="modal-stat"><div class="ms-val" style="color: var(--accent-blue);">${p.wins}</div><div class="ms-label">Total Wins</div></div>
    <div class="modal-stat"><div class="ms-val" style="color: var(--accent-rose);">${p.losses}</div><div class="ms-label">Total Losses</div></div>
    <div class="modal-stat"><div class="ms-val" style="color: var(--accent-purple);">${p.placed_pct}%</div><div class="ms-label">Placed Rate</div></div>
  `;

  // Build yearly chart if we have data
  const yearly = DATA.yearly_performance[p.player];
  if (modalChart) modalChart.destroy();

  if (yearly) {
    document.querySelector('.modal-chart').style.display = 'block';
    modalChart = new Chart(document.getElementById('modalChart'), {
      type: 'bar',
      data: {
        labels: yearly.map(y => y.year),
        datasets: [
          {
            label: 'Points',
            data: yearly.map(y => y.points),
            backgroundColor: COLORS.gold + 'bb',
            borderRadius: 4,
            borderSkipped: false,
            yAxisID: 'y',
          },
          {
            label: 'Win %',
            data: yearly.map(y => y.win_pct),
            type: 'line',
            borderColor: COLORS.emerald,
            backgroundColor: COLORS.emerald + '22',
            borderWidth: 2,
            pointRadius: 4,
            pointBackgroundColor: COLORS.emerald,
            tension: 0.3,
            yAxisID: 'y1',
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom' }
        },
        scales: {
          y: { position: 'left', title: { display: true, text: 'Points' }, beginAtZero: true },
          y1: { position: 'right', title: { display: true, text: 'Win %' }, beginAtZero: true, max: 100, grid: { drawOnChartArea: false } }
        }
      }
    });
  } else {
    document.querySelector('.modal-chart').style.display = 'none';
  }

  document.getElementById('playerModal').classList.add('active');
}

function closeModal() {
  document.getElementById('playerModal').classList.remove('active');
}

document.getElementById('playerModal').addEventListener('click', (e) => {
  if (e.target === e.currentTarget) closeModal();
});

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') { closeModal(); closeUploadModal(); }
});

// ===== ANIMATE NUMBERS =====
function animateNumber(el, target, duration = 1200) {
  const start = 0;
  const startTime = performance.now();
  const isDecimal = String(target).includes('.');

  function update(currentTime) {
    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed / duration, 1);
    const eased = 1 - Math.pow(1 - progress, 3);
    const current = Math.round(start + (target - start) * eased);
    el.textContent = current.toLocaleString();
    if (progress < 1) requestAnimationFrame(update);
  }
  requestAnimationFrame(update);
}

// ===== INIT =====
async function init() {
  // Show loading state
  const loadingEl = document.getElementById('loading-overlay');
  if (loadingEl) loadingEl.style.display = 'flex';

  try {
    await loadData();
  } catch (e) {
    if (loadingEl) loadingEl.style.display = 'none';
    const errEl = document.getElementById('data-error');
    if (errEl) {
      errEl.style.display = 'flex';
      document.getElementById('data-error-msg').textContent = e.message;
    }
    return;
  }

  if (loadingEl) loadingEl.style.display = 'none';
  deriveData();

  restoreTheme();
  applyChartDefaults();
  buildPodium();
  buildLeaderboardTable();
  buildPointsBreakdown();
  buildAllMiniBoards();
  buildCumulativeChart();
  buildAttendanceChart();
  buildWinRateDistribution();
  buildPPTDistribution();
  buildYearlyPoints();
  buildYearlyOverview();
  buildWinLossChart();
  buildRadarFilters();
  updateRadar();
  updateDataSourceInfo();

  // Animate summary numbers
  const totalGames = players.reduce((s, p) => s + p.total_games, 0);
  animateNumber(document.getElementById('stat-tournaments'), DATA.total_tournaments);
  animateNumber(document.getElementById('stat-players'), DATA.players.length);
  animateNumber(document.getElementById('stat-games'), totalGames);
  animateNumber(document.getElementById('stat-years'), DATA.years.length);

  // Upload modal: drag-and-drop + close handlers
  const dropZone = document.getElementById('upload-drop-zone');
  if (dropZone) {
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
    dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('drag-over'); });
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
      if (e.dataTransfer.files.length) handleFileUpload(e.dataTransfer.files[0]);
    });
  }
  document.getElementById('uploadModal').addEventListener('click', (e) => {
    if (e.target === e.currentTarget) closeUploadModal();
  });
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
