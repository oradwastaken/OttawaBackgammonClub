<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ottawa Area Backgammon Club - Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/variables.css">
<link rel="stylesheet" href="css/styles.css">
<link rel="stylesheet" href="css/modals.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
<script type="module" src="js/main.js"></script>
</head>
<body>

<div id="loading-overlay" class="loading-overlay">
  <div class="loading-spinner"></div>
  <div class="loading-text">Loading dashboard data...</div>
</div>
<div id="data-error" class="data-error" style="display:none;">
  <div class="data-error-icon">&#9888;</div>
  <div id="data-error-msg" class="data-error-message"></div>
  <button class="upload-btn" onclick="openUploadModal()">Upload Excel Data</button>
</div>

<div class="container">
  <!-- Header -->
  <div class="header fade-in">
    <div class="header-tools">
      <button class="theme-toggle" id="uploadBtn" onclick="openUploadModal()" title="Upload Excel data">&#128203;</button>
      <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="Toggle light/dark theme">&#9790;</button>
    </div>
    <div class="header-badge">Est. 2017 &bull; Weekly Tournaments</div>
    <h1>Ottawa Area Backgammon Club</h1>
    <p id="header-subtitle">Player Statistics &amp; Performance Dashboard &mdash; 396 Tournaments &bull; 85 Players &bull; 2017 &ndash; 2026</p>
    <p id="data-source-info" class="data-source-info">No data</p>
  </div>

  <!-- Filter Bar -->
  <div class="filter-bar card fade-in" id="filter-bar">
    <div class="filter-group">
      <span class="filter-label">Season:</span>
      <div class="year-pills" id="year-pills"></div>
      <button class="year-pill" id="all-time-btn" onclick="onAllTimeToggle()">All Time</button>
    </div>
    <div class="filter-group">
      <span class="filter-label">Min. Tournaments:</span>
      <input type="range" class="min-t-slider" id="min-t-slider" min="1" max="50" value="5" oninput="onMinTChange(this.value)">
      <span class="min-t-value" id="min-t-value">5</span>
    </div>
    <div class="filter-group spotlight-group">
      <span class="filter-label">Find Player:</span>
      <div class="spotlight-search-wrap">
        <input type="text" id="spotlight-search" class="spotlight-search" placeholder="Type a name...">
        <button class="spotlight-clear" id="spotlight-clear" title="Clear spotlight">&times;</button>
        <div id="spotlight-dropdown" class="spotlight-dropdown"></div>
      </div>
    </div>
  </div>

  <!-- Spotlight Player Card -->
  <div class="spotlight-card card fade-in" id="spotlight-card" style="display:none;" onclick="openSpotlightModal()">
    <div class="spotlight-card-header">
      <div class="spotlight-card-avatar" id="spotlight-avatar"></div>
      <div>
        <div class="spotlight-card-name" id="spotlight-name"></div>
        <div class="spotlight-card-rank" id="spotlight-rank"></div>
      </div>
    </div>
    <div class="spotlight-card-stats" id="spotlight-stats"></div>
  </div>

  <!-- Summary Stats -->
  <div class="summary-row">
    <div class="summary-stat fade-in stagger-1" style="--stat-accent: var(--accent-gold);">
      <div class="number" id="stat-tournaments">286</div>
      <div class="label">Tournaments</div>
    </div>
    <div class="summary-stat fade-in stagger-2" style="--stat-accent: var(--accent-blue);">
      <div class="number" id="stat-players">60</div>
      <div class="label">Players</div>
    </div>
    <div class="summary-stat fade-in stagger-3" style="--stat-accent: var(--accent-emerald);">
      <div class="number" id="stat-matches">4,208</div>
      <div class="label">Total Matches</div>
    </div>
    <div class="summary-stat fade-in stagger-4" style="--stat-accent: var(--accent-purple);">
      <div class="number" id="stat-years">7</div>
      <div class="label">Seasons</div>
    </div>
  </div>

  <!-- Leaderboard Section -->
  <div class="leaderboard-section">
    <div class="leaderboard-grid">
      <!-- Left: Podium + Table -->
      <div class="card fade-in" style="padding-bottom: 16px;">
        <div class="card-title" id="leaderboard-title"><span class="dot" style="background: var(--accent-gold);"></span> All-Time Points Leaderboard</div>
        <div class="podium" id="podium"></div>
        <div class="table-rest">
          <div class="table-row table-header">
            <span class="rank">#</span>
            <span class="name">Player</span>
            <span class="stat-val">Points</span>
            <span class="stat-val">W-L</span>
            <span class="stat-val">PPT</span>
          </div>
          <div id="leaderboard-table"></div>
        </div>
      </div>

      <!-- Right: Horizontal bar chart -->
      <div class="card fade-in leaderboard-chart-wrap">
        <div class="card-title"><span class="dot" style="background: var(--accent-blue);"></span> Points Breakdown</div>
        <div class="cumulative-search-wrap">
          <input type="text" id="breakdown-search" class="cumulative-search" placeholder="Add player...">
          <div id="breakdown-dropdown" class="cumulative-dropdown"></div>
        </div>
        <div id="breakdown-chips" class="cumulative-chips"></div>
        <div class="chart-container" style="min-height: 400px;">
          <canvas id="pointsBreakdownChart"></canvas>
        </div>
        <div style="font-size: 10px; color: var(--text-muted); margin-top: 8px;">Tournament Advancements = Semifinalist or Consolation Bracket Winner</div>
      </div>
    </div>
  </div>

  <!-- 4 Mini Leaderboards -->
  <div class="stats-grid">
    <div class="card fade-in stagger-1">
      <div class="card-title"><span class="dot" style="background: var(--accent-emerald);"></span> Top 10 Win Rate</div>
      <div class="mini-board-note" style="font-size: 10px; color: var(--text-muted); margin-bottom: 12px; margin-top: -12px;">Min. 5 tournaments</div>
      <ul class="mini-board" id="board-winrate"></ul>
    </div>
    <div class="card fade-in stagger-2">
      <div class="card-title"><span class="dot" style="background: var(--accent-cyan);"></span> Top 10 Points/Tournament</div>
      <div class="mini-board-note" style="font-size: 10px; color: var(--text-muted); margin-bottom: 12px; margin-top: -12px;">Min. 5 tournaments</div>
      <ul class="mini-board" id="board-ppt"></ul>
    </div>
    <div class="card fade-in stagger-3">
      <div class="card-title"><span class="dot" style="background: var(--accent-purple);"></span> Top 10 % Placed</div>
      <div class="mini-board-note" style="font-size: 10px; color: var(--text-muted); margin-bottom: 12px; margin-top: -12px;">Min. 5 tournaments</div>
      <ul class="mini-board" id="board-placed"></ul>
    </div>
    <div class="card fade-in stagger-4">
      <div class="card-title"><span class="dot" style="background: var(--accent-orange);"></span> Top 10 Attendance</div>
      <ul class="mini-board" id="board-attendance"></ul>
    </div>
  </div>

  <!-- Cumulative Points -->
  <div class="full-width">
    <div class="card fade-in">
      <div class="card-title"><span class="dot" style="background: var(--accent-gold);"></span> Cumulative Points Over Years</div>
      <div class="cumulative-search-wrap">
        <input type="text" id="cumulative-search" class="cumulative-search" placeholder="Add player...">
        <div id="cumulative-dropdown" class="cumulative-dropdown"></div>
      </div>
      <div id="cumulative-chips" class="cumulative-chips"></div>
      <div class="chart-container">
        <canvas id="cumulativeChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Club Growth & Weekly Attendance -->
  <div class="charts-grid-2">
    <div class="card fade-in">
      <div class="card-title"><span class="dot" style="background: var(--accent-blue);"></span> Club Growth &mdash; Yearly Overview</div>
      <div class="chart-container">
        <canvas id="yearlyOverviewChart"></canvas>
      </div>
    </div>
    <div class="card fade-in">
      <div class="card-title"><span class="dot" style="background: var(--accent-cyan);"></span> Weekly Attendance</div>
      <div class="chart-container">
        <canvas id="attendanceChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Yearly Top 5 Table -->
  <div class="full-width">
    <div class="card fade-in">
      <div class="card-title"><span class="dot" style="background: var(--accent-rose);"></span> Yearly Top 5 Players</div>
      <div id="yearlyPointsTable" class="yearly-top5-wrap"></div>
    </div>
  </div>

  <!-- Win/Loss Ratio Top 10 -->
  <div class="full-width">
    <div class="card fade-in">
      <div class="card-title"><span class="dot" style="background: var(--accent-orange);"></span> Win vs Loss &mdash; Top 10 Players</div>
      <div class="chart-container">
        <canvas id="winLossChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Win % Trend Over Time -->
  <div class="full-width">
    <div class="card fade-in">
      <div class="card-title"><span class="dot" style="background: var(--accent-emerald);"></span> Win % Trend Over Time</div>
      <div class="trend-controls">
        <div class="cumulative-search-wrap" style="max-width: 300px;">
          <input type="text" id="trend-search" class="cumulative-search" placeholder="Add player...">
          <div id="trend-dropdown" class="cumulative-dropdown"></div>
        </div>
        <div class="trend-slider-wrap" id="trend-slider-wrap">
          <span class="trend-slider-label">Rolling window:</span>
          <input type="range" class="trend-slider" id="trend-slider" min="10" max="200" value="50" oninput="onTrendWindowChange(this.value)">
          <span class="trend-slider-value" id="trend-slider-value">50</span>
          <span class="trend-slider-unit">matches</span>
        </div>
      </div>
      <div id="trend-chips" class="cumulative-chips"></div>
      <div id="trend-fallback-note" class="trend-fallback-note" style="display:none">
        Showing yearly averages &mdash; upload Excel for per-tournament detail.
      </div>
      <div class="chart-container" style="min-height: 360px;">
        <canvas id="trendChart"></canvas>
      </div>
    </div>
  </div>

  <div class="footer">
    Ottawa Area Backgammon Club &bull; Data from March 2017 to February 2026 &bull; 396 Weekly Tournaments
  </div>
</div>

<!-- Player Detail Modal -->
<div class="modal-overlay" id="playerModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal()">&times;</button>
    <h2 id="modal-name"></h2>
    <div class="modal-subtitle" id="modal-subtitle"></div>
    <div class="modal-year-toggle" id="modal-year-toggle"></div>
    <div class="modal-stats" id="modal-stats"></div>
    <div class="modal-chart">
      <canvas id="modalChart"></canvas>
    </div>
    <div class="modal-trend" id="modal-trend" style="display:none">
      <div class="modal-trend-header">
        <span class="modal-trend-title">Rolling Win %</span>
        <div class="modal-trend-controls">
          <input type="range" class="trend-slider" id="modal-trend-slider" min="10" max="200" value="50" oninput="onModalTrendSlider(this.value)">
          <span class="trend-slider-value" id="modal-trend-slider-value">50</span>
          <span class="trend-slider-unit">matches</span>
        </div>
      </div>
      <div class="modal-trend-canvas">
        <canvas id="modalTrendChart"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Upload Modal -->
<div class="modal-overlay" id="uploadModal">
  <div class="modal" style="max-width: 480px;">
    <button class="modal-close" onclick="closeUploadModal()">&times;</button>
    <h2>Update Dashboard Data</h2>
    <div class="modal-subtitle">Upload the latest Excel spreadsheet to refresh all stats</div>
    <div class="upload-drop-zone" id="upload-drop-zone" onclick="document.getElementById('upload-file-input').click()">
      <div class="upload-icon">&#128196;</div>
      <div class="upload-text">Drag &amp; drop your Excel file here</div>
      <div class="upload-subtext">or click to browse</div>
      <input type="file" id="upload-file-input" accept=".xlsx,.xls" style="display:none" onchange="handleFileUpload(this.files[0])">
    </div>
    <div id="upload-status" class="upload-status"></div>
    <div id="upload-actions" class="upload-actions" style="display:none;">
      <button class="upload-btn upload-btn-apply" onclick="applyUploadedData()">Apply Data</button>
      <button class="upload-btn upload-btn-cancel" onclick="closeUploadModal()">Cancel</button>
    </div>
    <div id="publish-actions" class="export-actions" style="display:none;">
      <button class="upload-btn publish-btn" onclick="publishToGitHub()" style="width:100%" id="publish-btn">Publish</button>
      <div id="publish-status" class="publish-status"></div>
    </div>
    <div id="github-settings" class="github-settings" style="display:none;">
      <div class="github-settings-title">Connection Settings <span class="github-settings-hint">(one-time setup)</span></div>
      <label class="github-label">Repository</label>
      <input type="text" id="gh-repo" class="github-input" placeholder="e.g. JohnSmith/OttawaBackgammonClub">
      <label class="github-label">Access Token</label>
      <input type="password" id="gh-token" class="github-input" placeholder="ghp_xxxxxxxxxxxx">
      <button class="upload-btn upload-btn-apply" onclick="saveGitHubSettings()" style="width:100%; margin-top:8px;">Save Settings</button>
    </div>
    <div class="upload-reset">
      <a href="#" onclick="toggleGitHubSettings(); return false;" id="gh-settings-link">Settings</a>
    </div>
  </div>
</div>

</body>
</html>
